# 高并发解决方案

### 高并发和大流量解决方案

> PHP如何解决网站大流量与高并发的问题 ?

**高并发架构相关概念**

**并发** , 在操作系统中 , 是指一个时间段中有几个程序都处于已启动运行到运行完毕之间 , 且这几个程序都是在同一个处理机上运行 , 但任一个时刻点上只有一个程序在处理机上运行 .

上面的定义明显不是我们通常所言的并发 , 在互联网时代 , 所讲的并发 , **高并发** , 通常是指并发访问 . 也就是在某个时间点 , 有多少个访问同时到来 .

通常 , 如果一个系统的日PV在千万以上 , 就有可能是一个高并发的系统了 . 有的公司完全不走技术路线 , 全靠机器堆 , 这里就不讨论了 .

> 高并发的问题 , 我们具体应该关心什么?

**QPS** : 每秒钟请求或者查询的数量 , 在互联网领域 , 指每秒响应请求数\(通常指HTTP请求\) ;

**吞吐量** : 单位时间内处理的请求数量 , 通常由QPS与并发数决定 .

**响应时间** : 从请求发出到收到响应花费的时间 . 例如 , 系统处理一个HTTP请求需要100ms , 这个100ms就是系统的响应时间 .

**PV** : 综合浏览量\(Page View\) , 即页面浏览量或者点击量 , 一个访客在24小时内访问的页面数量 . 同一个人浏览你的网站同一页面 , 只记作一次PV .

**UV** : 独立访客\(Unique Visitor\) , 即一定时间范围内相同访客多次访问网站 , 只计算为1个独立访客 .

**带宽** : 计算带宽大小需要关注两个指标 , 峰值流量和页面的平均大小 .

**日网站带宽** = PV / 统计时间\(86400秒\) \* 平均页面大小\(KB\) \* 8

**峰值**一般是平均值的倍数 , 根据实际情况确定 .

**QPS 不等于\(≠\) 并发链接数**

**QPS**是每秒HTTP请求数量 , **并发链接数**是系统同时处理的请求数量 .

**峰值QPS\(峰值每秒请求数\)** = \(总PV数\*80%\)/\(6小时秒数\*20%\)

表示80%的访问量集中在20%的时间 , 也就是二八定律 .

这里的6小时是一个简单的估计 .

**压力测试**

测试能承受的最大并发

测试最大承受的QPS值

**常用性能测试工具**

ab , wrk , http\_load , Web Bench , Siege , Apache JMeter

**ab - apache benchmark**

Apache官方推出的工具 , 它创建多个并发访问线程 , 模拟多个访问者同时对某一URL地址进行访问 . 它的测试目标是基于URL的 , 因此 , 它即可以用来测试apache的负载压力 , 也可以测试nginx , lighthttp , tomcat , IIS等其他Web服务器的压力 .

**使用**

模拟并发请求100次 , 总共请求5000次 .

```
ab -c 100 -n 5000 待测试URL
```

注意 , 测试机和被测试机应该分开 , 当然不要对线上服务做压测 .

观察测试工具ab所在机器 , 以及被测的前端机的CPU , 内存 , 网络等都不要超过最高限度的75% .

```
# 安装ab
yum provides /usr/bin/ab
yum install httpd-tools-2.4.6-80.el7.centos.x86_64
```

**QPS达到极限**

随着QPS的增长 , 每个阶段需要根据实际情况来进行优化 , 优化的方案也与硬件条件 , 网络带宽息息相关 .

**QPS达到50**

可以称之为小型网站 , 一般的服务器就可以应付 .

**QPS达到100**

假设关系型数据库的每次请求在0.01秒完成 \(接近完美\) .

假设单页面只有一个SQL查询 , 那么100QPS意味着1秒钟完成100次请求 , 但是此时我们并不能保证数据库查询能完成100次 .

方案 : 数据库缓存层 , 数据库的负载均衡 .

**QPS达到800**

假设我们使用百兆带宽 , 意味着网站出口的实际带宽是8M左右 , 假设每个页面只有10K , 在这个并发条件下 , 百兆带宽已经吃完 .

方案 : CDN加速 , 负载均衡 .

**QPS达到1000**



